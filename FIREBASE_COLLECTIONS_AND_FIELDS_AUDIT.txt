================================================================================
FIREBASE COLLECTIONS AND FIELDS AUDIT - SchoolNow Project
================================================================================
Generated: January 2, 2026
Project ID: busnow-applications
Database: Firestore + Realtime Database

================================================================================
1. FIRESTORE COLLECTIONS
================================================================================

---
COLLECTION: admins
---
Document ID: admin_id (string)

Fields:
  - email (string) - Admin email
  - password (string) - Admin password (should use Auth instead)
  - role (string) - Admin role identifier
  - created_at (timestamp) - Account creation
  - updated_at (timestamp) - Last update

---
COLLECTION: parents
---
Document ID: parentId (Firebase Auth UID)

Fields:
  - role (string) - "parent"
  - ic_number (string) - Parent IC number
  - ic_number_normalized (string) - Uppercase IC without special chars
  - name (string) - Parent name
  - email (string) - Email address
  - contact_number (string) - Phone number
  - address (string) - Home address
  - pickup_location (map) - Home location for pickup
    * lat (double) - Latitude
    * lng (double) - Longitude
  - notifications (map) - Notification preferences
    * proximity_alert (boolean) - Proximity alerts enabled
    * boarding_alert (boolean) - Boarding alerts enabled
  - created_at (timestamp) - Account creation
  - updated_at (timestamp) - Last update

Subcollections:
  └─ children (per parent)
      Document ID: childId (auto-generated)
      
      Fields:
        - child_name (string) - Student name
        - child_ic (string) - Student IC number
        - child_ic_normalized (string) - Uppercase IC without special chars
        - school_name (string) - School name
        - school_id (string) - School document ID
        - school_lat (double) - School latitude
        - school_lng (double) - School longitude
        - assigned_driver_id (string/null) - Assigned driver ID
        - attendance_override (string) - "attending" or "absent"
        - attendance_date_ymd (string) - Date in YYYY-MM-DD format
        - pickup_location (map) - Pickup location for student
          * lat (double) - Latitude
          * lng (double) - Longitude
        - created_at (timestamp) - Creation time
        - updated_at (timestamp) - Last update

---
COLLECTION: drivers
---
Document ID: driverId (Firebase Auth UID)

Fields:
  - role (string) - "driver"
  - ic_number (string) - Driver IC number
  - ic_number_normalized (string) - Uppercase IC without special chars
  - name (string) - Driver name
  - email (string) - Email address
  - contact_number (string) - Phone number
  - license_number (string) - Driver license number
  - assigned_bus_id (string) - Bus plate (normalized)
  - school_id (string) - School ID (optional)
  - is_verified (boolean) - Verification status
  - is_searchable (boolean) - Whether driver appears in parent search results
  - service_area (map) - Service coverage area (optional)
    * center_lat (double) - Center latitude
    * center_lng (double) - Center longitude
    * radius_km (double) - Service radius in kilometers
  - home_location (map) - Driver home location
    * lat (double) - Latitude
    * lng (double) - Longitude
  - active_trip_id (string/null) - Current active trip ID
  - active_trip_status (string) - Status of active trip
  - active_trip_updated_at (timestamp) - Trip status update time
  - monthly_fee (number) - Monthly operational fee
  - created_at (timestamp) - Account creation
  - updated_at (timestamp) - Last update

Subcollections:
  ├─ students (per driver) - READ-ONLY CACHE (auto-synced from parents/{parentId}/children)
  │   Document ID: studentId (same as child document ID)
  │   
  │   Fields:
  │     - child_id (string) - Child/Student ID
  │     - parent_id (string) - Parent document ID
  │     - child_name (string) - Student name
  │     - school_id (string) - School ID
  │     - school_name (string) - School name
  │     - contact_number (string) - Parent contact number
  │     - pickup_location (map) - Pickup location
  │       * lat (double) - Latitude
  │       * lng (double) - Longitude
  │     - attendance_override (string) - "attending" or "absent"
  │     - attendance_date_ymd (string) - Date in YYYY-MM-DD format
  │     - created_at (timestamp) - Creation time
  │     - updated_at (timestamp) - Last update
  │
  │   ⚠️ **NOTE**: This is a read-only cache maintained by the admin app. 
  │       The authoritative source is `parents/{parentId}/children/{childId}`.
  │       Updates should be made to the parent collection; driver cache syncs automatically
  │       via batch operations when students are added, updated, or reassigned.
  └─ service_requests (per driver)
      Document ID: requestId (auto-generated)
      
      Fields:
        - student_id (string) - Student document ID
        - parent_id (string) - Parent document ID
        - student_name (string) - Student name
        - parent_name (string) - Parent name
        - contact_number (string) - Parent contact number
        - pickup_location (map) - Pickup location
          * lat (double) - Latitude
          * lng (double) - Longitude
        - payment_id (string) - Payment document ID
        - amount (number) - Service request amount
        - status (string) - "pending", "approved", "rejected"
        - reason (string/null) - Rejection reason if applicable
        - created_at (timestamp) - Request creation time
        - updated_at (timestamp) - Last update

---
COLLECTION: schools
---
Document ID: schoolId (auto-generated)

Fields:
  - name (string) - School name
  - type (string) - "primary" or "secondary"
  - address (string) - School address
  - geo_location (map) - School location
    * lat (double) - Latitude
    * lng (double) - Longitude
  - created_at (timestamp) - Creation time
  - updated_at (timestamp) - Last update

---
COLLECTION: trips
---
Document ID: tripId (auto-generated)

Fields:
  - driver_id (string) - Driver ID
  - vehicle_id (string) - Vehicle/Bus ID
  - route_id (string) - Route identifier
  - route_type (string) - "morning", "primary_pm", "secondary_pm"
  - status (string) - "planned", "started", "completed"
  - passengers (array) - List of student passengers
    * student_id (string) - Student ID
    * status (string) - "not_boarded", "boarded", "alighted", "absent"
    * updated_at (timestamp) - Status update time
  - live_location_path (string) - Path to live location in RTDB
  - polyline_points (array) - Route polyline points (lat/lng pairs)
  - created_at (timestamp) - Trip creation time
  - updated_at (timestamp) - Last update
  - started_at (timestamp/null) - Trip start time
  - completed_at (timestamp/null) - Trip completion time

---
COLLECTION: payments
---
Document ID: paymentId (auto-generated)

Fields:
  - parent_id (string) - Parent document ID
  - driver_id (string) - Driver document ID
  - child_id (string) - Child/Student ID
  - amount (number) - Payment amount
  - status (string) - "pending", "completed", "refunded"
  - metadata (map) - Additional payment info
    * student_name (string) - Student name
    * parent_name (string) - Parent name
    * student_id (string) - Student ID
    * pickup_location (map) - Pickup location
      - lat (double)
      - lng (double)
    * payment_id (string) - Payment ID
  - created_at (timestamp) - Payment creation time
  - updated_at (timestamp) - Last update

---
COLLECTION: notifications
---
Document ID: notificationId (auto-generated)

Fields:
  - user_id (string) - User ID (driver, parent, or student)
  - type (string) - "proximity_alert", "boarding_alert", "payment", "request", etc.
  - message (string) - Notification message
  - read (boolean) - Read status
  - related_trip_id (string/null) - Related trip ID if applicable
  - related_student_id (string/null) - Related student ID if applicable
  - created_at (timestamp) - Creation time
  - updated_at (timestamp) - Last update

---
COLLECTION: settings
---
Document ID: "operator"

Fields:
  - address (string) - Operator address
  - latitude (double) - Operator location latitude
  - longitude (double) - Operator location longitude
  - contact_number (string) - Contact phone number
  - contact_email (string) - Contact email address
  - updated_at (timestamp) - Last update

---
COLLECTION: students
---
⚠️ **DEPRECATED** (January 2, 2026)

Document ID: studentId (auto-generated)

Fields:
  - name (string) - Student name
  - parent_id (string) - Parent document ID
  - school_id (string) - School document ID
  - driver_id (string/null) - Assigned driver ID (optional)
  - grade (string/null) - Student grade (optional)
  - section (string/null) - Student section (optional)
  - created_at (timestamp) - Creation time
  - updated_at (timestamp) - Last update

⚠️ **IMPORTANT**: This collection is NO LONGER USED in the application code.

**Migration Completed**:
  - All admin app code updated to use `parents/{parentId}/children` instead
  - StudentService rewritten to read from parent collections only
  - All cross-collection operations now use atomic batch writes
  - Single source of truth: `parents/{parentId}/children/{childId}`
  - Driver cache: `drivers/{driverId}/students/{childId}` (auto-synced)

**Status**: Can be safely deleted from Firestore after verification that no legacy code references it.
See section 12 for complete details on the data redundancy fix.

---
COLLECTION: buses
---
Document ID: busId (bus plate normalized - uppercase, no spaces)

Fields:
  - plate_number (string) - Bus plate number (uppercase)
  - plate (string) - DEPRECATED - use plate_number instead
  - capacity (integer) - Bus seating capacity
  - assigned_driver_id (string/null) - Assigned driver ID (optional)
  - is_assigned (boolean) - Whether bus is assigned to a driver
  - school_id (string) - School ID (optional)
  - created_at (timestamp) - Creation time
  - updated_at (timestamp) - Last update

================================================================================
2. FIREBASE REALTIME DATABASE
================================================================================

---
PATH: live_locations/{driverId}
---
Structure:
{
  "lat": double,
  "lng": double,
  "latitude": double (DEPRECATED - should use lat),
  "longitude": double (DEPRECATED - should use lng),
  "timestamp": number (milliseconds since epoch),
  "speed": double (km/h),
  "heading": double (degrees),
  "updated_at": number (milliseconds since epoch)
}

Updated by: Driver app (LiveLocationService)
Read by: Monitor app, Driver app, Admin app

---
PATH: boarding_status/{tripId}/{studentId}
---
Structure:
{
  "status": string - "not_boarded", "boarded", "alighted", "absent"
  "last_update": number (milliseconds since epoch)
}

Updated by: Driver app (during trip)
Read by: Monitor app (parent tracking)

================================================================================
3. CONSISTENCY NOTES AND ISSUES
================================================================================

✅ RESOLVED ISSUES:
  1. Parent pickup_location format standardized to {lat, lng}
  2. Child document now includes parent's pickup_location during creation
  3. _latLngFromMap helper now handles both {lat/lng} and {latitude/longitude}
  4. Service requests admin screen updated to read {lat, lng}
  5. School geo_location standardized to {lat, lng}
  6. Bus collection updated to use plate_number field consistently
  7. Payment automated with service request approval/rejection workflow
  8. Drivers collection now includes is_searchable field

⚠️ KNOWN INCONSISTENCIES:
  1. Live location fields use both 'lat/lng' and 'latitude/longitude' (DEPRECATED)
     → Impact: Both formats need to be supported in reading code
     → Resolution: Prefer 'lat/lng' format going forward (writing is consistent)
     → Status: Backward compatible, new data uses correct format

  2. Some legacy school documents may still use {latitude, longitude}
     → Impact: App code handles both formats for backward compatibility
     → Status: Backward compatible, new schools use {lat, lng} format

  3. Bus plate field naming in legacy data
     → Impact: Some docs may use 'plate' instead of 'plate_number'
     → Resolution: Admin app standardizes to 'plate_number' for new entries
     → Status: Backward compatible with both field names

⏱️ RECENT CHANGES (January 2, 2026):
  1. ✅ FIXED: Data redundancy - consolidated student data to single source of truth
     - Removed all `students` collection usage from admin app code
     - StudentService completely rewritten to use parent's children subcollections
     - All cross-collection operations now atomic via batch writes
  2. ✅ Service request approval now properly syncs to driver's students cache
  3. ✅ Service request rejection properly handles payment refunds
  4. ✅ Admin driver deletion checks driver's students subcollection (not students collection)
  5. ✅ All three apps pass flutter analyze with no errors

================================================================================
4. FIELD TYPE SUMMARY
================================================================================

Common Field Types Used:
  - String: Names, IDs, types, statuses, email, phone, address, etc.
  - Double: Latitude, longitude coordinates, radius, amount
  - Integer: Capacity, ratings
  - Boolean: Flags (is_verified, is_assigned, read, etc.)
  - Timestamp: created_at, updated_at, timestamps
  - Map: Nested objects (location, metadata, notifications, service_area)
  - Array: passengers, polyline_points, metadata arrays

================================================================================
5. AUTHENTICATION & SECURITY FIELDS
================================================================================

Authentication handled by:
  - Firebase Auth (Email/Password for parents and drivers)
  - IC number lookup for driver login
  - Student login with IC + parent password

Security Fields:
  - role: Identifies user type (parent, driver, student)
  - is_verified: Required for driver login
  - ic_number_normalized: Resilient matching for IC lookups

================================================================================
6. REFERENCES AND RELATIONSHIPS
================================================================================

Parent Document: drivers/{driverId}
└─ References:
   - drivers/{driverId}/students/{studentId}
   - drivers/{driverId}/service_requests/{requestId}
   - payments where driver_id = driverId
   - trips where driver_id = driverId
   - schools/{schoolId} via school_id field
   - buses/{busId} via assigned_bus_id field

Parent Document: parents/{parentId}
└─ References:
   - parents/{parentId}/children/{childId}
   - payments where parent_id = parentId
   - service_requests where parent_id = parentId

Parent Document: trips/{tripId}
└─ References:
   - drivers/{driverId} via driver_id field
   - Multiple children/{childId} via passengers array
   - Realtime DB: boarding_status/{tripId}/{studentId}

================================================================================
7. COLLECTION ACCESS PATTERNS
================================================================================

By Admin App:
  - admins/* (authenticate admin)
  - all collections (full CRUD access)
  - manage_schools_screen: schools/* (CRUD)
  - manage_drivers_screen: drivers/* (CRUD)
  - manage_students_screen: students/* + parents/{id}/children/* (CRUD)
  - manage_payments_screen: payments/* (read-only, status managed by requests)
  - manage_service_requests_screen: drivers/{id}/service_requests/* (read, update status)
  - manage_buses_screen: buses/* (CRUD)
  - buses/{busId} (read assigned bus info)

By Parent App:
  - parents/{userId} (read/update self)
  - parents/{userId}/children/* (CRUD own children)
  - schools/* (read only)
  - drivers/* (read, filtered by service_area and is_searchable)
  - drivers/{driverId}/service_requests/* (create, manage own requests)
  - payments/* (read own payments - where parent_id = userId)
  - trips/{tripId}/* (read trip details during active trip)
  - notifications/* (read own - where user_id = userId)
  - Realtime DB: live_locations/{driverId} (read during trip)
  - Realtime DB: boarding_status/{tripId}/{childId} (read during trip)

By Driver App:
  - drivers/{userId} (read/update self, watch assigned bus)
  - drivers/{userId}/students/* (read assigned students)
  - drivers/{userId}/service_requests/* (read pending requests)
  - trips/{tripId}/* (CRUD own trips)
  - trips/{tripId}/passengers/{studentId} (update boarding status)
  - parents/{parentId}/children/{childId} (read for student details)
  - schools/* (read for route planning)
  - buses/{plateId} (read own bus info)
  - notifications/* (read own)
  - Realtime DB: live_locations/{userId} (write own location continuously)
  - Realtime DB: boarding_status/{tripId}/{studentId} (update student status)
  - Realtime DB: settings/operator (read for operator location - afternoon routes)

================================================================================
8. DATA VALIDATION RULES
================================================================================

Email Validation:
  - Checked on registration (Firebase Auth)
  - Must be unique per user
  - Format: standard email format

IC Number Validation:
  - Normalized: removed special chars, uppercase
  - Must be unique per parent/driver
  - Used for resilient duplicate detection

Location Data:
  - Latitude: -90.0 to 90.0
  - Longitude: -180.0 to 180.0
  - Must be present for operational locations

Status Fields:
  - payments: "pending", "completed", "refunded"
  - trips: "planned", "started", "completed"
  - service_requests: "pending", "approved", "rejected"
  - boarding_status: "not_boarded", "boarded", "alighted", "absent"
  - attendance: "attending", "absent"
  - route_type: "morning", "primary_pm", "secondary_pm"

================================================================================
9. INDEXING RECOMMENDATIONS
================================================================================

Composite Indexes:
  - drivers: (is_verified, created_at)
  - parents: (created_at)
  - payments: (status, created_at)
  - drivers/{id}/service_requests: (status, created_at) - avoided in code
  - trips: (driver_id, status)
  - trips.passengers: (student_id, status)

Single Field Indexes:
  - All collections by: created_at, updated_at
  - parents: ic_number, ic_number_normalized
  - drivers: ic_number, ic_number_normalized, school_id
  - schools: name
  - children: school_id, assigned_driver_id

================================================================================
10. TIMESTAMP CONVENTION
================================================================================

Format: Firebase FieldValue.serverTimestamp()
Usage:
  - created_at: Set once on document creation
  - updated_at: Updated on every document modification
  - last_update: Used in Realtime DB for quick reference
  - Milliseconds: Used in Realtime DB (DateTime.now().millisecondsSinceEpoch)

================================================================================
11. APP-SPECIFIC FEATURES AND WORKFLOWS
================================================================================

DRIVER APP:
  - Live location tracking: Updates live_locations/{driverId} continuously during trips
  - Trip management: Creates/manages trips with route optimization (nearest neighbor)
  - Morning routes: Home → sorted student pickups → school
  - Afternoon routes (primary): School → sorted student dropoffs → operator home
  - Afternoon routes (secondary): School → sorted student dropoffs → operator home
  - Student boarding tracking: Updates boarding_status/{tripId}/{studentId}
  - Service requests: View pending requests and approve/manage them
  - Notifications: Receive alerts for proximity, boarding, and system events
  - Bus assignment: Watch assigned bus information in real-time

PARENT APP:
  - Child monitoring: Track assigned driver's live location during trips
  - Attendance: Set child as attending/absent for the day
  - Route visibility: See planned route with all stops and optimized paths
  - Service requests: Request a driver for child transportation
  - Notifications: Receive proximity alerts when driver is near pickup
  - Payment tracking: View payment status (managed automatically by requests)

ADMIN APP:
  - Comprehensive management: CRUD for all entities (schools, drivers, parents, students)
  - Service request workflow: Approve/reject requests with automatic student assignment
  - Payment management: View-only (payments updated automatically via workflows)
  - Analytics: Dashboard with system statistics and recent activities
  - Bus management: Track and assign buses to drivers
  - Driver verification: Verify drivers before they can operate in the system

PAYMENT WORKFLOW (AUTOMATED):
  1. Parent creates service request → payment created with status "pending"
  2. Admin approves request:
     - Payment auto-marked as "completed"
     - Student auto-assigned to driver
     - Student added to driver's students collection
  3. Admin rejects request:
     - Payment auto-marked as "refunded"
     - Request marked as rejected
  4. NOTE: Manual payment status changes removed from admin screens (workflow-controlled)

================================================================================
12. DATA REDUNDANCY FIX - STUDENT DATA CONSOLIDATION (January 2, 2026)
================================================================================

✅ **DATA REDUNDANCY ISSUE RESOLVED**

The system previously had THREE separate collections storing student/child data:
1. **OLD**: `parents/{parentId}/children/{childId}` (Primary)
2. **OLD**: `drivers/{driverId}/students/{studentId}` (Derived cache)
3. **OLD**: `students` collection (Admin-managed, no sync)

**Problem Was**: Admin updates didn't sync to other collections, causing inconsistency.

**Solution Implemented**:

SINGLE SOURCE OF TRUTH: `parents/{parentId}/children/{childId}`

**Architecture Change**:
```
parents/{parentId}/children/{childId}  ← PRIMARY SOURCE
  ├── child_name
  ├── school_id
  ├── assigned_driver_id
  ├── pickup_location
  └── [other child fields]

drivers/{driverId}/students/{childId}  ← READ-ONLY CACHE (auto-synced)
  ├── child_id
  ├── parent_id
  ├── child_name
  ├── school_id
  └── [synced fields]

students/  ← NO LONGER USED IN CODE
  └── [legacy data, safe to delete]
```

**Changes Made**:
✅ StudentService.getAllChildrenAsStudents() - Aggregates from all parent collections only
✅ StudentService.addStudent() - Creates child in parent's collection, syncs to driver via batch
✅ StudentService.updateStudent() - Updates parent collection with atomic batch sync to driver
✅ StudentService.deleteStudent() - Deletes from parent AND driver collections atomically
✅ service_request_service.dart - Syncs approved requests to driver's students cache
✅ admin_driver_service.dart - Checks driver's students subcollection (not students collection)
✅ All operations use Firestore batch writes for atomicity

**Current Sync Status (AFTER FIX)**:
✅ Parent operations → Sync to driver's students (batch operations, atomic)
✅ Admin approval → Creates/updates driver's students via batch write
✅ Admin reassignment → Removes from old driver, adds to new driver (batch)
✅ Admin deletion → Deletes from parent AND driver collections (batch)
✅ All updates atomic - succeed or fail together

**Code Changes**:
- Removed all `collection('students')` references from admin app
- StudentService completely rewritten (260+ lines)
- manage_students_screen.dart updated for batch operations
- All cross-collection updates use atomic batch writes

**Testing Results (January 2, 2026)**:
✅ school_now (parent app) - flutter analyze: No issues found
✅ school_now_admin (admin app) - flutter analyze: No issues found
✅ school_now_driver (driver app) - flutter analyze: No issues found

**Data Migration**:
✅ Backward compatible - no data migration needed
✅ Relationships already exist in children subcollections
✅ Legacy students collection can be safely ignored or deleted